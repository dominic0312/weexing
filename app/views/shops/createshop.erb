<script src="/assets/jquery-191.js"></script>
<script src="/assets/jquery-ui-1.10.4.custom.js"></script>
<script src="/assets/jquery.ui.dialog.extended-1.0.2.js"></script>
<script src="/assets/jquery.multiDialog.js"></script>
<script type="text/javascript" src="/assets/notify.js"></script>
<%= stylesheet_link_tag "pagenate.css" %>
<%= stylesheet_link_tag "shop2.css" %>
<%= stylesheet_link_tag "jquery-ui-1.10.4.custom.css" %>
<%= stylesheet_link_tag "jquery.multiDialog.css" %>
<%= stylesheet_link_tag "ui.notify.css" %>

<style>
	.openbtn {
		position: absolute;
		left: 200px;
		padding-top: 10px;
		padding-left: 10px;
		padding-right: 0px;
		padding-bottom: 10px;
		margin-top: 5px;
		border-radius: 8px;
		width: 40px
	}
	.trailbtn {
		left: 260px;
		width: 75px;
		padding-left: 13px;
	}
	.cancelbtn {
		left: 360px;
		width: 45px;
		padding-left: 13px;
	}
	.guidebtn {
		left: 690px;
		top: 25px;
		width: 75px;
		background: #CCC;
		font-family: Arial;
		color: grey;
		font-size: 16px;
	}
	.guidebtn:hover {
		background: #black;
		text-decoration: none;
	}
	p.guidefont {
		font-family: Microsoft  YaHei;
		color: grey;
		font-size: 12px;
	}

	.validateTips {
		border: 1px solid transparent;
		padding: 0.3em;
	}

	label, input {
		display: block;
	}

	label.trailinfo {
		margin-bottom: 8px
	}

	.ui-dialog .ui-state-error {
		padding: .3em;
	}
</style>

<div id="shops" class="shopsborder">
	<div id="newshopdiv" class="newshop">
		<div id="newshopbtn" class="nshoppbtn">
			添加新商家
		</div>

		<div id="first" style="display:none">
			<input type="text" id="shopname" style="position: absolute;top:8px;left:20px;background-color: #CCC;" placeholder="例如:xx酒店" title="此处输入商家名称，此名称不能更改."/>
			<a id="openbtn" class="nshoppbtn openbtn" href="#" onclick="openaccount(uid);return false;">开通</a>
			<a id="trailbtn" class="nshoppbtn openbtn trailbtn" href="#" onclick="requesttrail(uid);return false;">申请试用</a>
			<a id="cancelbtn" class="nshoppbtn openbtn cancelbtn" href="#" onclick="$('#first').hide('slide');return false;">取消</a>
			<span id="top"></span>
		</div>
		<div id="guide">
			<a id="guidebutton" class="openbtn guidebtn" href="#" onclick="showguide();return false;">开通指南</a>
		</div>
	</div>
	<div id="cont">
		<div id="wrapper" class="shopswrapper">

			<% @shops.each do |shop| %>
			<li class="shopgrid">

				<div class="sid" style="display:none">
					<%= shop.id%>
				</div>

				<div class="accountname">
					<%= shop.name%>
				</div>
				<div class="accountstartdate">
					<%= shop.created_at.to_s[0,10]%></br>开通
				</div>
				<div class="accountenddate">
					<%= shop.exprieddate.to_s[0,10]%></br>到期
				</div>

				<% if shop.online == 0%>
				<div class="status" id="status<%= shop.id%>">
					停止中
				</div>
				<% elsif shop.online == 1%>

				<div class="status-online" id="status<%= shop.id%>">
					运行中
				</div>
				<% end %>
				<% if shop.istrial == 0%>
				<div class="accountmanage">
					<% if shop.online == 0%><a class="nshoppbtn startbutton" id="onlinebtn<%= shop.id%>" onclick="online(<%= shop.id%>);return false;">上线</a><%elsif shop.online==1%> <a class="nshoppbtn stopbutton" id="onlinebtn<%= shop.id%>" onclick="online(<%= shop.id%>);return false;">下线</a>
					<%end%>
					<a id="chargebutton" class="nshoppbtn chargebutton" href="#">续费</a>
				</div>
				<%elsif shop.istrial == 1 %>
				<div class="accountmanagetrial">
					<a id="trialbutton" class="trialbutton" href="#">试用审核中,请等待</a>
				</div>
				<%end%>
			</li>
			<% end %>
		</div>
		<div class="digg_pagination shop_pag">
			<%= ajax_will_paginate @shops,:inner_window => 1,:outer_window=>1 %>
		</div>
	</div>
	<div id="test" style="display: none">

		<h1>hellowrold</h1>
	</div>
	<div id="uname" style="display:none">
		<%= @user_id%>
	</div>
	<div id="cred" style="display:none">
		<%= @credits%>
	</div>
	<div id="online" class="ui-helper-hidden" style="width:300px;overflow: hidden">
		<p>
			<span class="ui-icon ui-icon-info" style="float:left; margin:0 2px 20px 0;"></span>
			本操作将会使客户的会员卡业务上线,<b>请确认.</b>
		</p>
		<p>

		</p>
	</div>

	<div id="onlinesuc" class="ui-helper-hidden" style="width:300px;overflow: hidden">
		<p>
			<span class="ui-icon ui-icon-circle-check" style="float:left; margin:0 7px 50px 0;"></span>
			该客户成功上线！
		</p>
		<p>

		</p>
	</div>

	<div id="offlinesuc" class="ui-helper-hidden" style="width:300px;overflow: hidden">
		<p>
			<span class="ui-icon ui-icon-circle-check" style="float:left; margin:0 7px 50px 0;"></span>
			该客户已经下线！
		</p>
		<p>

		</p>
	</div>

	<div id="onlinefail" class="ui-helper-hidden" style="width:300px;overflow: hidden">
		<p>
			<span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 50px 0;"></span>
			上线失败，该网站已经过期，请充值！
		</p>
		<p>

		</p>
	</div>

	<div id="onlinefault" class="ui-helper-hidden" style="width:300px;overflow: hidden">
		<p>
			<span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 50px 0;"></span>
			没有成功上线，请联系管理员！
		</p>
		<p>

		</p>
	</div>

	<div id="offline" class="ui-helper-hidden" style="width:300px;overflow: hidden">
		<p>
			<span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 50px 0;"></span>
			本操作将会使客户的会员卡业务下线,<b>请确认.</b>
		</p>
		<p>

		</p>
	</div>

	<div id="trail-form" title="申请试用商家">
		<p class="validateTips">
			请输入以下信息申请试用:
		</p>

		<form>
			<fieldset>
				<label for="name" class="trailinfo">您的姓名</label>
				<input type="text" name="name" id="name" title="此处不能为空" class="text ui-widget-content ui-corner-all">
				<label for="company" class="trailinfo">公司名称</label>
				<input type="text" name="company" id="company" title="公司名字长度需要大于3字符"value="" class="text ui-widget-content ui-corner-all">
				<label for="phone" class="trailinfo">电话号码</label>
				<input type="text" name="phone" id="phone"  title="请输入您的常用手机号，这是本次试用的唯一凭证。" class="text ui-widget-content ui-corner-all">
			</fieldset>
		</form>
	</div>

</div>

<script>
	var uid = $.trim($("#uname").text());
	var credit = $.trim($("#cred").text());
	var tips = $(".validateTips");
	$(function() {
		$(document).tooltip();

		$(document).on('click', '.notifyjs-shops-guide .yes', function() {
			$(this).trigger('notify-hide');
		});

		$(document).on('click', '.notifyjs-uncharged-base .yes', function() {
			$(this).trigger('notify-hide');
		});

		$(document).on('click', '.notifyjs-charged-base .yes', function() {
			pay_create_user("create");
			$(this).trigger('notify-hide');
		});

		$(document).on('click', '.notifyjs-charged-base .no', function() {
			$(this).trigger('notify-hide');
		});

		$.notify.addStyle('shops', {
			html : "<div>" + "<div class='clearfix'>" + "<div class='title' data-notify-html='title'/>" + "<div class='content' data-notify-html='content'/>" + "</div>" + "<button class='yes'>关闭</button>" + "</div>",
			classes : {
				guide : {
				}
			}
		});

		$.notify.addStyle('uncharged', {
			html : "<div>" + "<div class='clearfix'>" + "<div class='title' data-notify-html='title'/>" + "<div class='content' data-notify-html='content'/>" + "</div>" + "<button class='yes'>确定</button>" + "</div>",
			classes : {
				base : {
				}
			}
		});

		$.notify.addStyle('charged', {
			html : "<div>" + "<div class='clearfix'>" + "<div class='title' data-notify-html='title'/>" + "<div class='content' data-notify-html='content'/>" + "</div>" + "<button class='yes'>确定</button>" + "<button class='no'>取消</button>" + "</div>",
			classes : {
				base : {
				}
			}
		});

		$.notify.addStyle('tips', {
			html : "<div>" + "<div class='clearfix'>" + "<div class='title' data-notify-html='title'/>" + "<div class='content' data-notify-html='content'/>" + "</div>" + "</div>",
			classes : {
				base : {
				}
			}
		});

		$.notify.addStyle('trail', {
			html : "<div>" + "<div class='clearfix'>" + "<div class='title' data-notify-html='title'/>" + "<div class='content' data-notify-html='content'/>" + +"<div class='textfield'><input type='text' id='hello1'/></div>" + "<button class='yes'>确定</button>" + "<button class='no'>取消</button>" + "</div>" + "</div>",
			classes : {
				base : {
				}
			}
		});

		$("#first").hide();

		$("#newshopbtn").click(function() {
			options = {};
			$("#first").show('slide');
			return false;
		});

		var name = $("#name"), company = $("#company"), phone = $("#phone"), allFields = $([]).add(name).add(company).add(phone);

		$("#trail-form").dialog({
			autoOpen : false,
			height : 500,
			width : 350,
			modal : true,
			buttons : {
				"提交" : function() {
					var bValid = true;
					allFields.removeClass("ui-state-error");

					bValid = bValid && checkLength(name, "姓名 ", 3, 16);
					bValid = bValid && checkLength(company, "公司名", 3, 80);
					//bValid = bValid && checkLength(phone, "电话号码", 11, 11);

					// From jquery.validate.js (by joern), contributed by Scott Gonzalez: http://projects.scottsplayground.com/email_address_validation/
					bValid = bValid && checkRegexp(phone, /[0-9]{11}/, "手机号码只能输入11位数字");

					if (bValid) {
						$(this).dialog("close");
						if (checkshopempty()) {
							return;
						}
						pay_create_user("trail");

					}
				},
				"取消" : function() {
					$(this).dialog("close");
				}
			},
			close : function() {
				allFields.val("").removeClass("ui-state-error");
			}
		});

	});

	function updateTips(t) {
		tips.text(t).addClass("ui-state-highlight");
		setTimeout(function() {
			tips.removeClass("ui-state-highlight", 1500);
		}, 500);
	}

	function checkLength(o, n, min, max) {
		if (o.val().length > max || o.val().length < min) {
			o.addClass("ui-state-error");
			updateTips(n + "的长度 需要在" + min + "字和 " + max + "字之间.");
			return false;
		} else {
			return true;
		}
	}

	function checkRegexp(o, regexp, n) {
		if (!( regexp.test(o.val()) )) {
			o.addClass("ui-state-error");
			updateTips(n);
			return false;
		} else {
			return true;
		}
	}

	function showguide() {
		if ($(".notifyjs-shops-guide").length > 0) {
			$(".notifyjs-shops-guide").trigger('notify-hide');
			return;
		}
		var guidestr = "<p>1.开通一个会员卡应用需要5点点数.</p>" + "<p>2.该开通费用包含一年的服务器使用费用，后续费用为3点/年.</p>" + "<p>3.购买点数请与我们的管理员联系，或参见首页指引.</p>" + "<p>4.申请试用的客户请点击<b>添加新商家->申请试用</b>按钮,提交信息后可以试用3天.</p>";
		$.notify({
			title : "<b>开通指南</b>",
			content : guidestr
		}, {
			style : 'shops',
			className : 'guide',
			autoHide : false,
			clickToHide : false
		});
	}

	//callback function to bring a hidden box back
	function requesttrail(id) {
		$("#trail-form").dialog("open");

	}

	function checkshopempty() {
		spnm = $.trim($("#shopname").val());
		if (spnm == "") {
			$.notify({
				content : "请不要忘记输入店铺名称。"
			}, {
				style : 'tips',
				className : 'base',
				autoHide : true,
				clickToHide : true,
				autoHideDelay : 2000
			});
			return true;
		}
		if ($(".notifyjs-uncharged-base").length > 0) {
			$(".notifyjs-uncharged-base").trigger('notify-hide');
			return;
		}

		if ($(".notifyjs-charged-base").length > 0) {
			$(".notifyjs-charged-base").trigger('notify-hide');
			return;
		}
	}

	function openaccount(id) {
		var uncharged = "<p>余额不足以支付此次操作，请充值。</p>";
		var charged = "<p>将使用5点来开启这个账户，请确认。</p>";

		if (checkshopempty()) {
			return;
		}

		if (credit < 5) {
			$.notify({
				title : "<b>余额不足</b>",
				content : uncharged
			}, {
				style : 'uncharged',
				className : 'base',
				autoHide : false,
				clickToHide : false
			});
		} else {
			$.notify({
				title : "<b>确认充值</b>",
				content : charged
			}, {
				style : 'charged',
				className : 'base',
				autoHide : false,
				clickToHide : false
			});
		}
	}

	function pay_create_user(istrial) {
		shopnm = $.trim($("#shopname").val());
		$.post("/shops/createshop", {
			userid : uid,
			payment : 3,
			shopname : shopnm,
			createtype : istrial
		}, null, "script");
	}

	function online(ref) {
		status = $.trim($("#status" + ref).html());
		if (status == "停止中") {
			$("#online").dialog({
				modal : false,
				buttons : {
					确认 : function() {
						$(this).dialog("close");
						onlinecmd(ref, "online");
					}
				}
			});
		}

		if (status == "运行中") {
			$("#offline").dialog({
				modal : false,
				buttons : {
					确认 : function() {
						$(this).dialog("close");
						onlinecmd(ref, "offline");
					}
				}
			});
		}
	}

	function onlinecmd(refs, cmd) {
		$.post("/shops/onlineshop", {
			userid : uid,
			shopid : refs,
			operation : cmd
		}, null, "script")

	}

	function onlinesuccess(sid) {

		$("#onlinesuc").dialog({
			modal : false,
			buttons : {
				关闭 : function() {
					$(this).dialog("close");
				}
			}
		});
		$("#status" + sid).removeClass('status').addClass('status-online');
		$("#status" + sid).html("运行中");
		$("#onlinebtn" + sid).removeClass('startbutton').addClass('stopbutton');
		$("#onlinebtn" + sid).html("下线");
	}

	function onlinefail() {

		$("#onlinefail").dialog({
			modal : false,
			buttons : {
				关闭 : function() {
					$(this).dialog("close");
				}
			}
		});
	}

	function offlinesuccess(sid) {

		$("#offlinesuc").dialog({
			modal : false,
			buttons : {
				关闭 : function() {
					$(this).dialog("close");
				}
			}
		});
		$("#status" + sid).removeClass('status-online').addClass('status');
		$("#status" + sid).html("停止中");
		$("#onlinebtn" + sid).removeClass('stopbutton').addClass('startbutton');
		$("#onlinebtn" + sid).html("上线");
	}

	function onlinefault() {
		$("#onlinefault").dialog({
			modal : false,
			buttons : {
				关闭 : function() {
					$(this).dialog("close");
				}
			}
		});
	}
</script>
